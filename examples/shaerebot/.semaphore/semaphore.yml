version: v1.0
name: default
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
- name: "Setup"
  task:
    jobs:
    - name: "mix and cache"
      commands:
        - checkout
        - mix local.rebar --force
        - mix local.hex --force
        - cache restore mix-deps-$(checksum mix.lock)
        - cache restore mix-build-$(checksum mix.lock)
        - mix deps.get
        - mix compile
        - MIX_ENV=test mix compile
        - cache store mix-deps-$(checksum mix.lock) deps
        - cache store mix-build-$(checksum mix.lock) _build

- name: "Tests"
  task:
    prologue:
      commands:
        - checkout
        - cache restore mix-deps-$(checksum mix.lock)
        - cache restore mix-build-$(checksum mix.lock)
        - mix local.rebar --force
        - mix local.hex --force
    jobs:
    - name: ExUnit
      env_vars:
      - name: MIX_ENV
        value: test
      commands:
        - mix test
